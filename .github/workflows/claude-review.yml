name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    name: Claude Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD -- '*.ts' '*.tsx' '*.js' '*.jsx' ':!*.test.*' ':!*.spec.*' > diff.txt
          echo "Diff size: $(wc -c < diff.txt) bytes"

      - name: Claude Code Review
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const fs = require('fs');

            let diff = '';
            try {
              diff = fs.readFileSync('diff.txt', 'utf8');
            } catch (e) {
              console.log('No diff file found');
              return;
            }

            if (!diff || diff.trim() === '') {
              console.log('No code changes to review');
              return;
            }

            // Truncate diff if too large (keep first 30KB)
            const maxLength = 30000;
            const truncated = diff.length > maxLength;
            const diffContent = truncated ? diff.substring(0, maxLength) + '\n...[truncated]' : diff;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4096,
                messages: [{
                  role: 'user',
                  content: `You are a senior code reviewer. Review this PR diff and provide:

            1. **Security Issues** - Any vulnerabilities, injection risks, auth problems
            2. **Bugs** - Logic errors, edge cases, potential runtime errors
            3. **Performance** - Inefficiencies, N+1 queries, memory leaks
            4. **Code Quality** - Readability, maintainability, best practices

            Be concise. Only mention issues that matter. If the code looks good, say so briefly.

            Format your response as markdown suitable for a GitHub PR comment.

            \`\`\`diff
            ${diffContent}
            \`\`\`
            `
                }]
              })
            });

            const data = await response.json();

            if (data.error) {
              console.log('Claude API error:', data.error);
              return;
            }

            const review = data.content[0].text;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ü§ñ Claude Code Review\n\n${review}${truncated ? '\n\n‚ö†Ô∏è *Note: Diff was truncated due to size*' : ''}\n\n---\n*Automated review by Claude*`
            });
